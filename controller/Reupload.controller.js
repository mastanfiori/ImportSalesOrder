/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","cus/sd/salesorder/imports1/utils/utility","cus/sd/salesorder/imports1/utils/commonEventHandler","sap/ui/core/MessageType","cus/sd/salesorder/imports1/utils/formatter","sap/base/util/deepExtend"],function(C,u,c,M,f,d){"use strict";return C.extend("cus.sd.salesorder.imports1.controller.Reupload",{formatter:f,commonEventHandler:c,sUploadName:"",sTest:"",sMessageStripStatusnull:"",sHistoryEntity:"",oFiledList:{},oUploadedFiledList:[],oP13nColumns:{headerColumns:[],itemColumns:[],headerRuntimeColumns:[],itemRuntimeColumns:[]},oPartnerFunctions:{WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},oItemPartnerFunctions:{AG:"SoldToParty",WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},tempHeaderRuntimeColumns:[],sImportPageMessageStripId:"importPageMessageStrip",onInit:function(){this.oPreviewTable=this.byId("reuploadHeaderTable");this.oColumnListItem=this.byId("reuploadHeaderListItem");this.oUploadCollection=this.byId("reuploadCollection");this.Uploader=this.byId("reuploadFileUploader");this.oDetailButton=this.byId("reuploadHeaderDetailBtn");this.FileNameImport=this.byId("reuploadFileName");this.utility=new u(this,"Header",true);this.sDataModelRootPath="reuploadSalesDoc>";var t=this;this.getView().attachBeforeRendering(this._BeforeViewRendering);this.getView().attachAfterRendering(this._AfterViewRendering,t);},initialModels:function(){this.oResourceBundle=this.getView().getParent().getModel("i18n").getResourceBundle();this.oUIModel=this.getView().getParent().getModel("reuploadUi");this.oImportDataModel=this.getView().getParent().getModel("reuploadSalesDoc");this.oP13nModel=this.getView().getParent().getModel("reuploadP13n");this.oMsgModel=this.getView().getParent().getModel("reuploadMsgDialog");this.oSalesDocImportID=this.getView().getParent().getModel("reuploadSlsDocImprtID");this.oReuploadDataModel=this.getView().getParent().getModel("reuploadData");this.oModel=this.getView().getParent().getModel();},_AfterViewRendering:function(){if(!this.oReuploadNavContainer){this.initialModels();this.ImportButton=this.getView().getParent().getParent().getParent().getButtons()[0];this.oReuploaderNavContainer=this.getView().getParent().getParent();var D=this.getView().getParent().getModel("document");this.oModelName=D.getProperty("/modelName");this.sKeyField=D.getProperty("/keyField");this.setUploadURL(this.oModelName);this.oPreviewView=this.getView();var o=this.oModel;var v=this.getView();var t=this;if(o.getMetaModel()){o.getMetaModel().loaded().then(function(){v.setModel(o.getMetaModel(),"meta");t.prepareFieldlist(o.getMetaModel());});}}},prepareFieldlist:function(m){if(!m){return;}var D=this.getView().getParent().getModel("document");var s=D.getProperty("/modelName");var F=D.getProperty("/importFieldEntity");var i=D.getProperty("/importItemFieldEntity");var p=D.getProperty("/importPrincingFieldEntity");var I=D.getProperty("/keyItemField");var o=m.getODataEntityType(s+"."+F);if(o&&o.property&&o.property.length>0){var a=o.property;for(var b in a){var n=a[b].name;this.oFiledList[n]=a[b];if(n===this.sKeyField&&typeof(a[b]["sap:label"]!==undefined)){a[b]["sap:label"]=this.oResourceBundle.getText("SALES_ORDER_PREVIEW_LABEL");}}}var e=m.getODataEntityType(s+"."+i);if(e&&e.property&&e.property.length>0){var g=e.property;for(var h in g){var j=g[h].name;if(j===I&&typeof(g[h]["sap:label"]!==undefined)){g[h]["sap:label"]=this.oResourceBundle.getText("ITEM_PREVIEW_LABEL");g[h]["sap:quickinfo"]=this.oResourceBundle.getText("ITEM_PREVIEW_TOOLTIP");}if(j==="Material"&&typeof(g[h]["sap:label"]!==undefined)){g[h]["sap:label"]=this.oResourceBundle.getText("PRODUCT_PREVIEW_LABEL");g[h]["sap:quickinfo"]=this.oResourceBundle.getText("PRODUCT_PREVIEW_TOOLTIP");}if(!this.oFiledList[j]){this.oFiledList[j]=g[h];}}}var P=m.getODataEntityType(s+"."+p);if(P&&P.property&&P.property.length>0){var k=P.property;for(var l in k){var q=k[l].name;if(!this.oFiledList[q]){this.oFiledList[q]=k[l];}}}var t=m.getODataEntityType(s+".SalesDocumentItemText");if(t&&t.property&&t.property.length>0){var T=t.property;for(var r in T){var v=T[r].name;this.oFiledList[v]=T[r];}}var w=m.getODataEntityType(s+".SalesBusinessPartner");if(w&&w.property&&w.property.length>0){var x=w.property;for(var y in x){var A=x[y].name;if(!this.oFiledList[A]){this.oFiledList[A]=x[y];}}}this.oFiledList["ProductStandardID"]={"name":"ProductStandardID","type":"String","sap:display-format":"","sap:label":this.oResourceBundle.getText("GTIN_PREVIEW_LABEL"),"sap:quickinfo":this.oResourceBundle.getText("GTIN_PREVIEW_TOOLTIP")};return;},_BeforeViewRendering:function(e){var p=this.getParent().getBindingContext().getPath();var s=this.getParent().getModel().getObject(p).SalesDocumentImportName;this.byId("reuploadFileName").setValue(s);},setUploadURL:function(m){var U="/sap/opu/odata/sap/"+m+"/ExcelDataSet";this.oUploadCollection.setUploadUrl(U);this.Uploader.setUploadUrl(U);},buildTable:function(s,S){this.utility.buildPreviewTable(s,S);var b=this.sDataModelRootPath+"/salesHeaderData";this.oPreviewTable.bindItems({path:b,template:this.oColumnListItem});},onHeaderSettingDialogPress:function(){var p=sap.ui.xmlfragment("cus.sd.salesorder.imports1.view.fragment.SettingDialogForHeader",this);p.setModel(this.oP13nModel);this.oPreviewView.addDependent(p);p.open();},onChangeColumnsItems:function(e){this.tempHeaderRuntimeColumns=e.getParameter("items");},onHeaderSettingOk:function(e){if(this.tempHeaderRuntimeColumns.length!==0){this.oP13nColumns.headerRuntimeColumns=d([],this.tempHeaderRuntimeColumns);this.tempHeaderRuntimeColumns.length=0;}var r=this.oP13nColumns.headerRuntimeColumns;var s=[];var S=[];for(var i in r){s.push(r[i].columnKey);if(r[i].visible===true){S.push(r[i].columnKey);}}this.utility.clearTable();this.buildTable(s,S);e.getSource().close();this.oPreviewTable.firePopinChanged();},onHeaderSettingCancel:function(e){this.oP13nModel.setProperty("/headerRuntimeColumns",d([],this.oP13nColumns.headerRuntimeColumns));e.getSource().close();}});});
