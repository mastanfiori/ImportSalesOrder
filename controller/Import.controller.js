/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","cus/sd/salesorder/imports1/utils/formatter","cus/sd/salesorder/imports1/utils/commonEventHandler","cus/sd/salesorder/imports1/utils/utility","sap/ui/table/Column","sap/ui/unified/Currency","sap/m/ObjectStatus","sap/ui/model/json/JSONModel","sap/ui/core/MessageType","sap/m/MessageBox","sap/f/library","sap/base/util/deepExtend","sap/m/ResponsivePopover","sap/m/Button","sap/ui/core/Fragment","sap/ui/core/Item","sap/m/MessageStrip","sap/m/Link"],function(C,f,c,u,a,b,O,J,M,d,e,g,R,B,F,I,h,L){"use strict";return C.extend("cus.sd.salesorder.imports1.controller.Import",{formatter:f,commonEventHandler:c,sUploadName:"",sTest:"",sMessageStripStatusnull:"",sHistoryEntity:"",oFiledList:{},oUploadedFiledList:[],oP13nColumns:{headerColumns:[],itemColumns:[],headerRuntimeColumns:[],itemRuntimeColumns:[]},oPartnerFunctions:{WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},oItemPartnerFunctions:{AG:"SoldToParty",WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},tempHeaderRuntimeColumns:[],sImportPageMessageStripId:"importPageMessageStrip",onInit:function(){this.initialModels();this.oPreviewTable=this.byId("importHeaderTable");this.oColumnListItem=this.byId("importHeaderListItem");this.oUploadCollection=this.byId("importUploadCollection");this.Uploader=this.byId("importFileUploader");this.ImportButton=this.byId("importButton");this.oDetailButton=this.byId("importHeaderDetailBtn");this.FileNameImport=this.byId("importFileNameImport");this.oPreviewView=this.getView();this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("master").attachPatternMatched(this.onRoutePatternMatched,this);this.utility=new u(this,"Header");this.sDataModelRootPath="importSalesOrder>";var D=this.getOwnerComponent().getModel("document");this.sHistoryEntity=D.getProperty("/historyEntity");this.oModelName=D.getProperty("/modelName");this.sKeyField=D.getProperty("/keyField");this.setUploadURL(this.oModelName);this._initialShareAction();},onRoutePatternMatched:function(E){var l=E.getParameters().arguments.layout;if(l===undefined){this.utility._hidePreviewTable();}if(this.bNavigateFromDuplicateDilog){this.oUIModel.setProperty("/uploadJobName",this.sImportName);this.commonEventHandler._dealWithDuplicate.call(this);}},setDocumentModel:function(m){var D=this.getOwnerComponent().getModel("document");if(m){if(!(D.getProperty("/bReplaced"))){D.setProperty("/modelName",m.modelName);D.setProperty("/keyField",m.keyField);D.setProperty("/keyItemField",m.keyItemField);D.setProperty("/importFieldEntity",m.importFieldEntity);D.setProperty("/importItemFieldEntity",m.importItemFieldEntity);D.setProperty("/importPrincingFieldEntity",m.importPrincingFieldEntity);D.setProperty("/importEntity",m.importEntity);D.setProperty("/historyEntity",m.historyEntity);D.setProperty("/historyItemEntity",m.historyItemEntity);D.setProperty("/bReplaced",true);}}this.oModelName=D.getProperty("/modelName");this.sKeyField=D.getProperty("/keyField");this.sHistoryEntity=D.getProperty("/historyEntity");this.setUploadURL(this.oModelName);},initialModels:function(){this.oResourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.oUIModel=this.getOwnerComponent().getModel("ui");this.oImportDataModel=this.getOwnerComponent().getModel("importSalesOrder");this.oP13nModel=this.getOwnerComponent().getModel("p13n");this.oMsgModel=this.getOwnerComponent().getModel("msgDialog");var v=this.getView();var D=this.getOwnerComponent().getModel();this.oModel=D;var t=this;if(D.getMetaModel()){D.getMetaModel().loaded().then(function(){v.setModel(D.getMetaModel(),"meta");t.prepareFieldlist(D.getMetaModel());});}},prepareFieldlist:function(m){if(!m){return;}var D=this.getOwnerComponent().getModel("document");var s=D.getProperty("/modelName");var i=D.getProperty("/importFieldEntity");var j=D.getProperty("/importItemFieldEntity");var p=D.getProperty("/importPrincingFieldEntity");var k=D.getProperty("/keyItemField");var o=m.getODataEntityType(s+"."+i);if(o&&o.property&&o.property.length>0){var l=o.property;for(var n in l){var N=l[n].name;this.oFiledList[N]=l[n];if(N===this.sKeyField&&typeof(l[n]["sap:label"]!==undefined)){l[n]["sap:label"]=this.oResourceBundle.getText("SALES_ORDER_PREVIEW_LABEL");}}}var q=m.getODataEntityType(s+"."+j);if(q&&q.property&&q.property.length>0){var r=q.property;for(var t in r){var v=r[t].name;if(v===k&&typeof(r[t]["sap:label"]!==undefined)){r[t]["sap:label"]=this.oResourceBundle.getText("ITEM_PREVIEW_LABEL");r[t]["sap:quickinfo"]=this.oResourceBundle.getText("ITEM_PREVIEW_TOOLTIP");}if(v==="Material"&&typeof(r[t]["sap:label"]!==undefined)){r[t]["sap:label"]=this.oResourceBundle.getText("PRODUCT_PREVIEW_LABEL");r[t]["sap:quickinfo"]=this.oResourceBundle.getText("PRODUCT_PREVIEW_TOOLTIP");}if(!this.oFiledList[v]){this.oFiledList[v]=r[t];}}}var P=m.getODataEntityType(s+"."+p);if(P&&P.property&&P.property.length>0){var w=P.property;for(var x in w){var y=w[x].name;if(!this.oFiledList[y]){this.oFiledList[y]=w[x];}}}var T=m.getODataEntityType(s+".SalesDocumentItemText");if(T&&T.property&&T.property.length>0){var z=T.property;for(var A in z){var E=z[A].name;this.oFiledList[E]=z[A];}}var G=m.getODataEntityType(s+".SalesBusinessPartner");if(G&&G.property&&G.property.length>0){var H=G.property;for(var K in H){var Q=H[K].name;if(!this.oFiledList[Q]){this.oFiledList[Q]=H[K];}}}this.oFiledList["ProductStandardID"]={"name":"ProductStandardID","type":"String","sap:display-format":"","sap:label":this.oResourceBundle.getText("GTIN_PREVIEW_LABEL"),"sap:quickinfo":this.oResourceBundle.getText("GTIN_PREVIEW_TOOLTIP")};return;},setUploadURL:function(m){var U="/sap/opu/odata/sap/"+m+"/ExcelDataSet";this.oUploadCollection.setUploadUrl(U);this.Uploader.setUploadUrl(U);},onAfterRendering:function(){this.oUploadCollection=this.byId("importUploadCollection");var t=this.oUploadCollection.getToolbar();t.setVisible(false);},onImportNameChange:function(E){var v=this.FileNameImport.getValue();v=typeof(v)==="string"?v.trim():v;var p=this.oPreviewTable.getVisible();var i=this.sMessageStripStatus;if(v===undefined||v===""){if(p){this.FileNameImport.setValueState("Error");this.FileNameImport.setValueStateText(this.oResourceBundle.getText("MSG_ENTER_IMPORT_NAME"));this.ImportButton.setEnabled(false);if(i===M.Success){sap.ui.getCore().byId(this.sImportPageMessageStripId).setProperty("visible",false);}}}else if(v.length>100){this.FileNameImport.setValueState("Error");this.FileNameImport.setValueStateText(this.oResourceBundle.getText("MSG_IMPORT_NAME_MAX_LENGTH"));this.ImportButton.setEnabled(false);if(i===M.Success){sap.ui.getCore().byId(this.sImportPageMessageStripId).setProperty("visible",false);}}else{this.FileNameImport.setValueState("None");this.FileNameImport.setValueStateText("");if(p){if(i===M.Error){this.ImportButton.setEnabled(false);}else{this.ImportButton.setEnabled(true);}sap.ui.getCore().byId(this.sImportPageMessageStripId).setProperty("visible",true);}}},onCancelPressed:function(E){this.utility._hidePreviewTable();window.history.go(-1);},onDownloadTemplatePressed:function(E){var r=this.getOwnerComponent().getModel().sServiceUrl+"/ExcelDataSet('')/$value";window.open(r,"_self");return true;},onShowLogsButtonPressed:function(E){this.utility._hidePreviewTable();this.oRouter.navTo("history",{layout:e.LayoutType.OneColumn});},backToMasterPage:function(){var l=this.oUIModel.getProperty("/layout");if(l!==e.LayoutType.OneColumn){this.oRouter.navTo("master",{layout:e.LayoutType.OneColumn},true);}},buildTable:function(s,S){this.utility.buildPreviewTable(s,S);var i=this.sDataModelRootPath+"/salesHeaderData";this.oPreviewTable.bindItems({path:i,template:this.oColumnListItem});this.oPreviewTable.firePopinChanged();},onImport:function(E){this.ImportButton.setEnabled(false);var m=this.getOwnerComponent().getModel();var n={};var i=this.FileNameImport.getValue();i=typeof(i)==="string"?i.trim():i;n.SalesDocumentImportName=i;n.SlsDocImprtdFileContentHash=this.SlsDocImprtdFileContentHash;n.to_ImportHistItem=this.oUploadData.to_ImportHistItem;var D=this.getOwnerComponent().getModel("document");var s=D.getProperty("/importEntity");m.create(s,n,{success:this.handleImportSuccess.bind(this),error:this.handleImportError.bind(this)});this.oPreviewView.setBusy(true);},handleImportSuccess:function(s,r){this.oPreviewView.setBusy(false);var t=this;var S=this.oResourceBundle.getText("BUTTON_SHOW_LOGS");var i=r.data.SalesDocumentImportID;d.information(this.oResourceBundle.getText("IMPORT_INFORMATION"),{actions:[S,sap.m.MessageBox.Action.OK],onClose:function(A){switch(A){case S:var E=t.sHistoryEntity+"('"+i+"')";t.oRouter.navTo("ImportHistoryDetail",{layout:e.LayoutType.OneColumn,entity:E});break;case"OK":break;}}});this.utility._hidePreviewTable();},handleImportError:function(E){this.ImportButton.setEnabled(true);this.oPreviewView.setBusy(false);var s=this.oResourceBundle.getText("MSG_ERROR_OCCUR");try{var o=JSON.parse(E.responseText);}catch(i){d.error(s);return;}if(o.error&&o.error.message&&o.error.message.value){d.error(s,{details:o.error.message.value});}else{d.error(s);}},onHeaderSettingDialogPress:function(){var p=sap.ui.xmlfragment("cus.sd.salesorder.imports1.view.fragment.SettingDialogForHeader",this);p.setModel(this.oP13nModel);this.oPreviewView.addDependent(p);p.open();},onChangeColumnsItems:function(E){this.tempHeaderRuntimeColumns=E.getParameter("items");},onHeaderSettingOk:function(E){if(this.tempHeaderRuntimeColumns.length!==0){this.oP13nColumns.headerRuntimeColumns=g([],this.tempHeaderRuntimeColumns);this.tempHeaderRuntimeColumns.length=0;}var r=this.oP13nColumns.headerRuntimeColumns;var s=[];var S=[];for(var i in r){s.push(r[i].columnKey);if(r[i].visible===true){S.push(r[i].columnKey);}}this.utility.clearTable();this.buildTable(s,S);E.getSource().close();this.oPreviewTable.firePopinChanged();},onHeaderSettingCancel:function(E){this.oP13nModel.setProperty("/headerRuntimeColumns",g([],this.oP13nColumns.headerRuntimeColumns));E.getSource().close();},onShareActionList:function(E){var v=this.getView(),s=E.getSource();if(!this.ShareActionPopover){this.ShareActionPopover=F.load({id:v.getId(),name:"cus.sd.salesorder.imports1.view.fragment.ActionSheet",controller:this}).then(function(p){v.addDependent(p);return p;});}this.ShareActionPopover.then(function(p){p.openBy(s);});},_initialShareAction:function(E){var v=this.getView();if(!this.ShareActionPopover){this.ShareActionPopover=F.load({id:v.getId(),name:"cus.sd.salesorder.imports1.view.fragment.ActionSheet",controller:this}).then(function(p){v.addDependent(p);return p;});}},onShareEmailButton:function(E){sap.m.URLHelper.triggerEmail("",this.oResourceBundle.getText("TITLE_SEND_EMAIL"),window.location.href);}});});
