/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/ui/generic/app/navigation/service/NavigationHandler","cus/sd/salesorder/imports1/utils/formatter","sap/f/library","sap/ui/core/library","sap/ui/core/InvisibleMessage","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/core/MessageType","sap/m/MessageStrip","sap/m/Link","sap/ui/model/odata/v2/ODataModel","cus/sd/salesorder/imports1/utils/utility","cus/sd/salesorder/imports1/utils/commonEventHandler","sap/ui/core/Item","cus/sd/salesorder/imports1/utils/CONSTANTS","cus/sd/salesorder/imports1/utils/customUIFactory"],function(C,F,a,N,f,l,b,I,c,M,d,e,L,O,u,g,h,k,m){"use strict";var n=b.InvisibleMessageMode;return C.extend("cus.sd.salesorder.imports1.controller.ImportHistoryDetail",{formatter:f,customUIFactory:m,commonEventHandler:g,oSetAsCompletedModel:new O(k.SET_AS_COMPLETED_MODEL_URL),sUploadName:"",sMessageStripinDetailHistoryPage:"sMessageStripinDetailHistoryPage",oFiledList:{},oUploadedFiledList:[],oP13nColumns:{headerColumns:[],itemColumns:[],headerRuntimeColumns:[],itemRuntimeColumns:[]},oPartnerFunctions:{WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},oItemPartnerFunctions:{AG:"SoldToParty",WE:"ShipToParty",RE:"BillToParty",RG:"PayerParty",VE:"SalesEmployee",ZM:"ResponsibleEmployee"},onInit:function(o){this.oModel=this.getOwnerComponent().getModel();this.oResourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.oSalesDocImportID=this.getOwnerComponent().getModel("reuploadSlsDocImprtID");this.oReuploadDataModel=this.getOwnerComponent().getModel("reuploadData");this.oUIModel=this.getOwnerComponent().getModel("reuploadUi");this.oSearchfield=this.byId("searchItems");this.oSmartTable=this.byId("importHistoryItemSmartTable");this.oRefreshBtn=this.byId("btn-refresh");var D=this.getOwnerComponent().getModel("document");this.sHistoryEntity=D.getProperty("/historyEntity");this.sHistoryItemEntity=D.getProperty("/historyItemEntity");this.oSmartTable.setEntitySet(this.sHistoryItemEntity);this.utility=new u(this,"Header");this.oRouter=this.getOwnerComponent().getRouter("ImportHistoryDetail");this.oRouter.getRoute("ImportHistoryDetail").attachPatternMatched(this.onRoutePatternMatched,this);this.oInvisibleMessage=I.getInstance();this.oModel.attachRequestCompleted(this._onModelRequestCompleted.bind(this));this.onInitLogComponent();this.bOnInitFinished=true;this.setObjectPageIcon();this._toggleSetAsCompletedUI();},setDocumentModel:function(o){var D=this.getOwnerComponent().getModel("document");if(o){if(!(D.getProperty("/bReplaced"))){D.setProperty("/modelName",o.modelName);D.setProperty("/keyField",o.keyField);D.setProperty("/keyItemField",o.keyItemField);D.setProperty("/importFieldEntity",o.importFieldEntity);D.setProperty("/importItemFieldEntity",o.importItemFieldEntity);D.setProperty("/importPrincingFieldEntity",o.importPrincingFieldEntity);D.setProperty("/importEntity",o.importEntity);D.setProperty("/historyEntity",o.historyEntity);D.setProperty("/historyItemEntity",o.historyItemEntity);D.setProperty("/bReplaced",true);}}this.sHistoryEntity=D.getProperty("/historyEntity");this.sHistoryItemEntity=D.getProperty("/historyItemEntity");this.oSmartTable.setEntitySet(this.sHistoryItemEntity);var H=D.getProperty("/historyItemEntity");this.oSmartTable.setEntitySet(H);this.setObjectPageIcon();},setObjectPageIcon:function(){var D=this.getOwnerComponent().getModel("document");var K=D.getProperty("/keyField");if(K==="SalesQuotation"){this.byId("Picture").setSrc("sap-icon://sales-quote");}},_onModelRequestCompleted:function(E){if(E.id===undefined||E.id.indexOf("reupload")===-1){var p=E.getParameters();switch(p.method){case"POST":return;case"GET":if(p.url.indexOf(this.sHistoryEntity+"(")>=0){this.checkCreationStatus(E,"H");}else if(p.url.indexOf(this.sHistoryItemEntity+"(")>=0&&p.url.indexOf("count")<0){}return;default:return;}}else{}},checkCreationStatus:function(E,t){var T=d.Error;var s=this.oResourceBundle.getText("CORRECTION_ERROR");var p=E.getParameters();var S=false;if(t==="H"){this.distroyMessageBox(this.sMessageStripinDetailHistoryPage);var P=JSON.parse(p.response.responseText).d.SlsDocImprtProcessingStatus;if(P&&(P==="1")){if(!this.byId(this.sMessageStripinDetailHistoryPage)){this._generateMsgStrip(T,s);}this.processStatusEmpty=false;}else{this.processStatusEmpty=true;}}else if(t==="I"&&this.processStatusEmpty===true){this.distroyMessageBox(this.sMessageStripinDetailHistoryPage);if(JSON.parse(p.response.responseText).d.results){var i=JSON.parse(p.response.responseText).d.results;if(i&&i.length>0){for(var j in i){if(i[j].SalesDocumentCreationStatus==="3"){S=true;break;}}}}}},distroyMessageBox:function(s){if(s){var o=sap.ui.getCore().byId(s);if(o){o.destroy();}}},_generateMsgStrip:function(t,T){var v=this.byId("HITableLayout");this.bMessageStripStatus=t;var o=new e(this.sMessageStripinDetailHistoryPage,{text:T,showCloseButton:false,showIcon:true,type:t});if(t!==d.Success){o.setLink(new L({text:this.oResourceBundle.getText("MSG_REUPLOAD_LINK")}).attachPress(this.onReuploadClick,this));}var s="";switch(t){case d.Information:s=this.oResourceBundle.getText("INFORMATION");break;case d.Success:s=this.oResourceBundle.getText("SUCCESS");break;case d.Warning:s=this.oResourceBundle.getText("WARNING");break;case d.Error:s=this.oResourceBundle.getText("ERROR");break;default:s="";}this.oInvisibleMessage.announce(s+" "+T,n.Assertive);v.insertContent(o,0);},onReuploadClick:function(){var v=this.getView();var t=this;if(!this.reuploadDialog){this.reuploadDialog=c.load({id:v.getId(),name:"cus.sd.salesorder.imports1.view.fragment.ReuploadDialog",controller:this}).then(function(D){v.addDependent(D);return D;});}this.reuploadDialog.then(function(D){D.open();if(!t.reuploadNavBackButton){var p=t.getView().getBindingContext().getPath();var s=t.oModel.getObject(p).SalesDocumentImportName;t.reuploadView=t.byId("reuploadView");t.reuploadButton=t.byId("reuploadButton");t.reuploadNavBackButton=t.byId("reuploaderNavBack");t.oReuploaderNavContainer=t.byId("reuploadNavContainer");t.reupoadDialogTitle=t.byId("reuploadDialogTitle");t.reuploadNavBackButton.setVisible(false);}});},onCloseReuploaderDialog:function(E){var t=this;this.reuploadDialog.then(function(D){D.destroy();t.reuploadDialog=null;t.reuploadNavBackButton=null;});},onNavBackToReuploadHeaderView:function(){this.reuploadNavBackButton.setVisible(false);this.reupoadDialogTitle.setText(this.oResourceBundle.getText("REUPLOAD_DIALOG_HEADER_TITLE"));this.oReuploaderNavContainer.back();},onInitLogComponent:function(){this.sLogID=this.utility.processNameByDate("appLogFragment");if(!this._oAppLogDialog){this._oAppLogDialog=sap.ui.xmlfragment(this.sLogID,"cus.sd.salesorder.imports1.view.fragment.ApplicationLog",this);this.getView().addDependent(this._oAppLogDialog);}var s="/sap/opu/odata/sap/APL_LOG_MANAGEMENT_SRV/";if(!this.oComp){this.oComp=sap.ui.getCore().createComponent({name:"sap.nw.core.applogs.lib.reuse.applogs",id:this.createId("LogMessagesControlComponent"),settings:{"persistencyKey":"ImportLogDetail","showHeader":false,"showFilterBar":false,"logDataServiceUrl":s}});var o=sap.ui.core.Fragment.byId(this.sLogID,"LogMessagesControlContainer");o.setComponent(this.oComp);}},onRoutePatternMatched:function(E){if(E.getParameter("name")==="ImportHistoryDetail"){var s=E.getParameter("arguments").entity;s=decodeURI(s);this.sEntityPath=s;var p=/(?<=')[^']*/g;var i=s.match(p);if(i){this.oSalesDocImportID.setProperty("/SalesDocImportID",i[0]);this.SalesDocumentImportID=i[0];}else{this.oSalesDocImportID.setProperty("/SalesDocImportID","");this.SalesDocumentImportID="";}if(this.reuploadDialog){var t=this;this.reuploadDialog.then(function(D){D.destroy();t.reuploadDialog=null;t.reuploadNavBackButton=null;});}this.getView().bindElement({path:"/"+s});if(this.initialized===true){this.onRefreshClick(E);}else{this.getView().getObjectBinding().refresh();this.initialized=true;}}if(!this.oPlaceholderContainer){this.oPlaceholderContainer=E.getParameter("targetControl");}},onBeforeRebindTable:function(E){var B=E.getParameter("bindingParams");var o=B.filters;o.push(new a("SalesDocumentImportID",F.EQ,this.SalesDocumentImportID));if(this.oSearchfield){var s=this.oSearchfield.getValue();if(!B.parameters.custom){B.parameters.custom={};}B.parameters.custom.search=s;}if(B.sorter===undefined||B.sorter.length===0){B.sorter=[new sap.ui.model.Sorter("SalesDocumentTemporaryID",false)];}E.getParameter("bindingParams").events.dataReceived=function(){if(this.oPlaceholderContainer){this.oPlaceholderContainer.hidePlaceholder({aggregation:'beginColumnPages'});}this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).fireSelectionChange();}.bind(this);},onRefreshClick:function(E){this.getView().getObjectBinding().refresh();this.oSmartTable.rebindTable();this.onItemInnerTableSelectionChange();},onSearchItems:function(E){this.oSmartTable.rebindTable();},onBackToHisotry:function(E){this.oRouter.navTo("history",{layout:l.LayoutType.OneColumn});},onSmartLinkNavigate:function(E){this.storeCurrentAppState();},onLogCloseBtnPressed:function(E){E.getSource().getParent().close();},onLogIconPressed:function(E){this.sLogID=this.utility.processNameByDate("appLogFragment");if(!this._oAppLogDialog){this._oAppLogDialog=sap.ui.xmlfragment(this.sLogID,"cus.sd.salesorder.imports1.view.fragment.ApplicationLog",this);this.getView().addDependent(this._oAppLogDialog);}var t=this;var s="/sap/opu/odata/sap/APL_LOG_MANAGEMENT_SRV/";if(!this.oComp){this.oComp=sap.ui.getCore().createComponent({name:"sap.nw.core.applogs.lib.reuse.applogs",id:this.createId("LogMessagesControlComponent"),settings:{"persistencyKey":"ImportLogDetail","showHeader":false,"showFilterBar":false,"logDataServiceUrl":s}});var o=sap.ui.core.Fragment.byId(this.sLogID,"LogMessagesControlContainer");o.setComponent(this.oComp);}var S=E.getSource();var p=S.getParent();var P=p.getBindingContext().getPath();var i=t.oModel.getObject(P).ApplicationLogHandle;this.oComp.setLogHandle(i);this.oComp.refresh();this._oAppLogDialog.open();},onExit:function(E){this.oRouter.getRoute("ImportHistoryDetail").detachPatternMatched(this.onRoutePatternMatched,this);this._oAppLogDialog.destroy();var t=this;if(this.reuploadDialog){this.reuploadDialog.then(function(D){D.destroy();t.reuploadDialog=null;t.reuploadNavBackButton=null;});}},onImport:function(E){this.reuploadButton.setEnabled(false);var o=this.getOwnerComponent().getModel();var i={};var s=this.oUIModel.getProperty("/uploadJobName");s=typeof(s)==="string"?s.trim():s;i.SalesDocumentImportName=s;i.SalesDocumentImportID=this.oSalesDocImportID.getProperty("/SalesDocImportID");this.oUploadData=this.oReuploadDataModel.getProperty("/reuploadData");i.to_ImportHistItem=this.oUploadData.to_ImportHistItem;var D=this.getOwnerComponent().getModel("document");var j=D.getProperty("/importEntity");o.create(j,i,{success:this.handleImportSuccess.bind(this),error:this.handleImportError.bind(this)});var t=this;this.reuploadDialog.then(function(p){p.destroy();t.reuploadDialog=null;t.reuploadNavBackButton=null;});this.getView().setBusy(true);},handleImportSuccess:function(s,r){this.getView().setBusy(false);M.information(this.oResourceBundle.getText("REUPLOAD_SUCCESS_MESSAGE"));this.onRefreshClick();},handleImportError:function(E){this.getView().setBusy(false);var s=this.oResourceBundle.getText("MSG_ERROR_OCCUR");try{var o=JSON.parse(E.responseText);}catch(i){M.error(s);return;}if(o.error&&o.error.message&&o.error.message.value){M.error(s,{details:o.error.message.value});}else{M.error(s);}},onItemInnerTableSelectionChange:function(){var r=this._getShouldUpdateListItems();var i=r.aShouldUpdateListItems.length===0?false:true;this.byId(k.IMPORT_HISTORY_ITEM_SET_AS_COMPLETED_BUTTON_ID).setEnabled(i);},onPressSetAsCompleted:function(E){var _=this.getView().getModel("i18n").getResourceBundle();if(!this._oConfirmManuallyCompletedDialog){this._oConfirmManuallyCompletedDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:_.getText("MNLLY_CMPLTD_CONFM_DIALOG_TITLE"),state:sap.ui.core.ValueState.Information,beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:_.getText("BUTTON_CONFIRM"),press:function(){this._sendRequestToSetAsCompleted.call(this);this._oConfirmManuallyCompletedDialog.close();}.bind(this)}),endButton:new sap.m.Button({type:sap.m.ButtonType.Transparent,text:_.getText("BUTTON_CANCEL"),press:function(){this._oConfirmManuallyCompletedDialog.close();}.bind(this)})});}var r=this._getShouldUpdateListItems();this._oConfirmManuallyCompletedDialog.destroyContent();if(r.aShouldUpdateListItems.length>1){if(r.allValid===true){this._oConfirmManuallyCompletedDialog.addContent(new sap.m.Text({text:_.getText("MNLLY_CMPLTD_CONFM_MSG_FOR_ALL_VALID_ITEM",[r.aShouldUpdateListItems.length])}));}else{this._oConfirmManuallyCompletedDialog.addContent(new sap.m.Text({text:_.getText("MNLLY_CMPLTD_CONFM_DIALOG_MESSAGE_ITEM",[r.aShouldUpdateListItems.length])}));}}else if(r.aShouldUpdateListItems.length===1){if(r.allValid===true){this._oConfirmManuallyCompletedDialog.addContent(new sap.m.Text({text:_.getText("MNLLY_CMPLTD_CONFM_MSG_FOR_ONE_SEL_ITEM",[r.aShouldUpdateListItems.length])}));}else{this._oConfirmManuallyCompletedDialog.addContent(new sap.m.Text({text:_.getText("MNLLY_CMPLTD_CONFM_MSG_FOR_ONE_VALID_ITEM",[r.aShouldUpdateListItems.length])}));}}else{return;}this._oConfirmManuallyCompletedDialog.open();},_sendRequestToSetAsCompleted:function(){var r=this._getShouldUpdateListItems();var s=r.aShouldUpdateListItems;if(s&&s.length>0){var o=this.getView().getModel();o.setDeferredGroups(["batchFunctionImport"]);this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).setBusy(true);for(var i=0;i<s.length;i++){var S=s[i].getBindingContext().getProperty("SalesDocumentImportID");var j=s[i].getBindingContext().getProperty("SalesDocumentTemporaryID");o.callFunction("/SetAsCompleted",{method:"POST",batchGroupId:"batchFunctionImport",changeSetId:i,urlParameters:{"SalesDocumentImportID":S,"SalesDocumentTemporaryID":j}});}o.submitChanges({batchGroupId:"batchFunctionImport",success:this._sendRequestToSetAsCompletedSuccess.bind(this),error:this._sendRequestToSetAsCompletedFail.bind(this)});}},_sendRequestToSetAsCompletedSuccess:function(D){this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).setBusy(false);this.onRefreshClick();var _=this.getView().getModel("i18n").getResourceBundle();var B=D.__batchResponses;var s=0;var i=0;var o=0;var p="";var P="";var q=[];var r="";for(var j=0;j<B.length;j++){var t=B[j].__changeResponses[0];var v=t.data.MessageTitle;var w=t.data.MessageText;var x=t.data.MessageDetail;switch(t.data.MessageType){case"S":s+=1;q.push({"type":sap.ui.core.MessageType.Success,"title":v,"subtitle":w,"description":x===""?w:x});break;case"E":i+=1;o+=p!==w?1:0;p=w;P=x;q.push({"type":sap.ui.core.MessageType.Error,"title":v,"subtitle":w,"description":x===""?w:x});break;}}if(i===0){this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).removeSelections(true);if(s>1){sap.m.MessageToast.show(_.getText("SUCCESS_MESSAGE_FOR_MANUALLY_COMPLETED_ITEM",[s]));}else{sap.m.MessageToast.show(_.getText("SUCCESS_MESSAGE_FOR_SINGLE_MANUALLY_COMPLETED_ITEM"));}}else{var y=_.getText("BUTTON_CLOSE");if(s===0&&o<=1){if(P===""){M.error(p);}else{M.error(P+p);}}else{r=s===0?_.getText("TITLE_ERROR"):_.getText("TITLE_PARTIALLY_COMPLETED");var z=this.customUIFactory.buildMessageViewDialog(q,r,y);z.open();}}},_sendRequestToSetAsCompletedFail:function(E){this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).setBusy(true);this.onRefreshClick();var _=this.getView().getModel("i18n").getResourceBundle();var t=_.getText("TECHNICAL_ERROR_MESSAGE");var s=_.getText("BUTTON_CLOSE");var o=this.customUIFactory.buildMessageViewDialog([{"type":sap.ui.core.MessageType.Error,"title":t}],"",s);o.open();},_getShouldUpdateListItems:function(){var r={allValid:true,aShouldUpdateListItems:[]};var p=this.byId(k.IMPORT_HISTORY_DETAIL_PAGE.PROCESSING_STATUS_OS_ID);var s=p.getBindingContext().getProperty("SlsDocImprtProcessingStatus");var j=this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).getSelectedItems();if([k.PROCESSING_STATUS_CODE.CONTAINS_ERRORS].includes(s)&&j&&j.length>=1){for(var i=0;i<j.length;i++){var B=j[i].getBindingContext();var S=B.getProperty("SalesDocumentCreationStatus");if([k.CREATION_STATUS_CODE.FAILED].includes(S)){r.aShouldUpdateListItems.push(j[i]);}else{r.allValid=false;}}}return r;},_toggleSetAsCompletedUI:function(){this.byId(k.IMPORT_HISTORY_ITEM_SET_AS_COMPLETED_BUTTON_ID).setVisible(true);this.byId(k.IMPORT_HISTORY_ITEM_INNER_TABLE_ID).setMode(sap.m.ListMode.MultiSelect);this.byId("CountOfMnllyCmpltdLayOut").setVisible(true);}});});
